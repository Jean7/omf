<html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="text/html;charset=UTF-8" http-equiv="content-type"/><title>OMF Portal</title><script src='/resource/js/defaults.js' type='text/javascript'></script><script src='/resource/js/lightbox.js' type='text/javascript'></script>
<link href='/resource/css/coderay.css' media='screen' rel='Stylesheet type='text/css'><link href='/resource/css/screen.css' media='screen' rel='Stylesheet type='text/css'><link href='/resource/css/welcome.css' media='screen' rel='Stylesheet type='text/css'><!--[if IE]><link href='/resource/css/ie.css' media='screen' rel='Stylesheet type='text/css'><![endif]--></head>


<body class="CodeRay">
<div class="CodeRay">

<span class="r">module</span> <span class="cl">CodeRay</span>

  <span class="c"># Version: Major.Minor.Teeny[.Revision]</span>
  <span class="c"># Major: 0 for pre-stable, 1 for stable</span>
  <span class="c"># Minor: feature milestone</span>
  <span class="c"># Teeny: development state, 0 for pre-release</span>
  <span class="c"># Revision: Subversion Revision number (generated on rake gem:make)</span>
  <span class="co">VERSION</span> = <span class="s"><span class="dl">'</span><span class="k">0.8</span><span class="dl">'</span></span>

  require <span class="s"><span class="dl">'</span><span class="k">coderay/tokens</span><span class="dl">'</span></span>
  require <span class="s"><span class="dl">'</span><span class="k">coderay/scanner</span><span class="dl">'</span></span>
  require <span class="s"><span class="dl">'</span><span class="k">coderay/encoder</span><span class="dl">'</span></span>
  require <span class="s"><span class="dl">'</span><span class="k">coderay/duo</span><span class="dl">'</span></span>
  require <span class="s"><span class="dl">'</span><span class="k">coderay/style</span><span class="dl">'</span></span>


  <span class="r">class</span> &lt;&lt; <span class="cl">self</span>

    <span class="c"># Scans the given +code+ (a String) with the Scanner for +lang+.</span>
    <span class="c">#</span>
    <span class="c"># This is a simple way to use CodeRay. Example:</span>
    <span class="c">#  require 'coderay'</span>
    <span class="c">#  page = CodeRay.scan(&quot;puts 'Hello, world!'&quot;, :ruby).html</span>
    <span class="c">#</span>
    <span class="c"># See also demo/demo_simple.</span>
    <span class="r">def</span> <span class="fu">scan</span> code, lang, options = {}, &amp;block
      scanner = <span class="co">Scanners</span>[lang].new code, options, &amp;block
      scanner.tokenize
    <span class="r">end</span>

    <span class="c"># Scans +filename+ (a path to a code file) with the Scanner for +lang+.</span>
    <span class="c">#</span>
    <span class="c"># If +lang+ is :auto or omitted, the CodeRay::FileType module is used to</span>
    <span class="c"># determine it. If it cannot find out what type it is, it uses</span>
    <span class="c"># CodeRay::Scanners::Plaintext.</span>
    <span class="c">#</span>
    <span class="c"># Calls CodeRay.scan.</span>
    <span class="c">#</span>
    <span class="c"># Example:</span>
    <span class="c">#  require 'coderay'</span>
    <span class="c">#  page = CodeRay.scan_file('some_c_code.c').html</span>
    <span class="r">def</span> <span class="fu">scan_file</span> filename, lang = <span class="sy">:auto</span>, options = {}, &amp;block
      file = <span class="co">IO</span>.read filename
      <span class="r">if</span> lang == <span class="sy">:auto</span>
        require <span class="s"><span class="dl">'</span><span class="k">coderay/helpers/file_type</span><span class="dl">'</span></span>
        lang = <span class="co">FileType</span>.fetch filename, <span class="sy">:plaintext</span>, <span class="pc">true</span>
      <span class="r">end</span>
      scan file, lang, options = {}, &amp;block
    <span class="r">end</span>

    <span class="c"># Scan the +code+ (a string) with the scanner for +lang+.</span>
    <span class="c">#</span>
    <span class="c"># Calls scan.</span>
    <span class="c">#</span>
    <span class="c"># See CodeRay.scan.</span>
    <span class="r">def</span> <span class="fu">scan_stream</span> code, lang, options = {}, &amp;block
      options[<span class="sy">:stream</span>] = <span class="pc">true</span>
      scan code, lang, options, &amp;block
    <span class="r">end</span>

    <span class="c"># Encode a string in Streaming mode.</span>
    <span class="c">#</span>
    <span class="c"># This starts scanning +code+ with the the Scanner for +lang+</span>
    <span class="c"># while encodes the output with the Encoder for +format+.</span>
    <span class="c"># +options+ will be passed to the Encoder.</span>
    <span class="c">#</span>
    <span class="c"># See CodeRay::Encoder.encode_stream</span>
    <span class="r">def</span> <span class="fu">encode_stream</span> code, lang, format, options = {}
      encoder(format, options).encode_stream code, lang, options
    <span class="r">end</span>

    <span class="c"># Encode a string.</span>
    <span class="c">#</span>
    <span class="c"># This scans +code+ with the the Scanner for +lang+ and then</span>
    <span class="c"># encodes it with the Encoder for +format+.</span>
    <span class="c"># +options+ will be passed to the Encoder.</span>
    <span class="c">#</span>
    <span class="c"># See CodeRay::Encoder.encode</span>
    <span class="r">def</span> <span class="fu">encode</span> code, lang, format, options = {}
      encoder(format, options).encode code, lang, options
    <span class="r">end</span>

    <span class="c"># Highlight a string into a HTML &lt;div&gt;.</span>
    <span class="c">#</span>
    <span class="c"># CSS styles use classes, so you have to include a stylesheet</span>
    <span class="c"># in your output.</span>
    <span class="c">#</span>
    <span class="c"># See encode.</span>
    <span class="r">def</span> <span class="fu">highlight</span> code, lang, options = { <span class="sy">:css</span> =&gt; <span class="sy">:class</span> }, format = <span class="sy">:div</span>
      encode code, lang, format, options
    <span class="r">end</span>

    <span class="c"># Encode pre-scanned Tokens.</span>
    <span class="c"># Use this together with CodeRay.scan:</span>
    <span class="c">#</span>
    <span class="c">#  require 'coderay'</span>
    <span class="c">#  </span>
    <span class="c">#  # Highlight a short Ruby code example in a HTML span</span>
    <span class="c">#  tokens = CodeRay.scan '1 + 2', :ruby</span>
    <span class="c">#  puts CodeRay.encode_tokens(tokens, :span)</span>
    <span class="c">#</span>
    <span class="r">def</span> <span class="fu">encode_tokens</span> tokens, format, options = {}
      encoder(format, options).encode_tokens tokens, options
    <span class="r">end</span>

    <span class="c"># Encodes +filename+ (a path to a code file) with the Scanner for +lang+.</span>
    <span class="c">#</span>
    <span class="c"># See CodeRay.scan_file.</span>
    <span class="c"># Notice that the second argument is the output +format+, not the input language.</span>
    <span class="c">#</span>
    <span class="c"># Example:</span>
    <span class="c">#  require 'coderay'</span>
    <span class="c">#  page = CodeRay.encode_file 'some_c_code.c', :html</span>
    <span class="r">def</span> <span class="fu">encode_file</span> filename, format, options = {}
      tokens = scan_file filename, <span class="sy">:auto</span>, get_scanner_options(options)
      encode_tokens tokens, format, options
    <span class="r">end</span>

    <span class="c"># Highlight a file into a HTML &lt;div&gt;.</span>
    <span class="c">#</span>
    <span class="c"># CSS styles use classes, so you have to include a stylesheet</span>
    <span class="c"># in your output.</span>
    <span class="c">#</span>
    <span class="c"># See encode.</span>
    <span class="r">def</span> <span class="fu">highlight_file</span> filename, options = { <span class="sy">:css</span> =&gt; <span class="sy">:class</span> }, format = <span class="sy">:div</span>
      encode_file filename, format, options
    <span class="r">end</span>

    <span class="c"># Finds the Encoder class for +format+ and creates an instance, passing</span>
    <span class="c"># +options+ to it.</span>
    <span class="c">#</span>
    <span class="c"># Example:</span>
    <span class="c">#  require 'coderay'</span>
    <span class="c">#  </span>
    <span class="c">#  stats = CodeRay.encoder(:statistic)</span>
    <span class="c">#  stats.encode(&quot;puts 17 + 4\n&quot;, :ruby)</span>
    <span class="c">#  </span>
    <span class="c">#  puts '%d out of %d tokens have the kind :integer.' % [</span>
    <span class="c">#    stats.type_stats[:integer].count,</span>
    <span class="c">#    stats.real_token_count</span>
    <span class="c">#  ]</span>
    <span class="c">#  #-&gt; 2 out of 4 tokens have the kind :integer.</span>
    <span class="r">def</span> <span class="fu">encoder</span> format, options = {}
      <span class="co">Encoders</span>[format].new options
    <span class="r">end</span>

    <span class="c"># Finds the Scanner class for +lang+ and creates an instance, passing</span>
    <span class="c"># +options+ to it.</span>
    <span class="c">#</span>
    <span class="c"># See Scanner.new.</span>
    <span class="r">def</span> <span class="fu">scanner</span> lang, options = {}
      <span class="co">Scanners</span>[lang].new <span class="s"><span class="dl">'</span><span class="dl">'</span></span>, options
    <span class="r">end</span>

    <span class="c"># Extract the options for the scanner from the +options+ hash.</span>
    <span class="c">#</span>
    <span class="c"># Returns an empty Hash if &lt;tt&gt;:scanner_options&lt;/tt&gt; is not set.</span>
    <span class="c">#</span>
    <span class="c"># This is used if a method like CodeRay.encode has to provide options</span>
    <span class="c"># for Encoder _and_ scanner.</span>
    <span class="r">def</span> <span class="fu">get_scanner_options</span> options
      options.fetch <span class="sy">:scanner_options</span>, {}
    <span class="r">end</span>

  <span class="r">end</span>

  <span class="c"># This Exception is raised when you try to stream with something that is not</span>
  <span class="c"># capable of streaming.</span>
  <span class="r">class</span> <span class="cl">NotStreamableError</span> &lt; <span class="co">Exception</span>
    <span class="r">def</span> <span class="fu">initialize</span> obj
      <span class="iv">@obj</span> = obj
    <span class="r">end</span>

    <span class="r">def</span> <span class="fu">to_s</span>
      <span class="s"><span class="dl">'</span><span class="k">%s is not Streamable!</span><span class="dl">'</span></span> % <span class="iv">@obj</span>.class
    <span class="r">end</span>
  <span class="r">end</span>

  <span class="c"># A dummy module that is included by subclasses of CodeRay::Scanner an CodeRay::Encoder</span>
  <span class="c"># to show that they are able to handle streams.</span>
  <span class="r">module</span> <span class="cl">Streamable</span>
  <span class="r">end</span>

<span class="r">end</span>

<span class="c"># Run a test script.</span>
<span class="r">if</span> <span class="gv">$0</span> == <span class="pc">__FILE__</span>
  <span class="gv">$stderr</span>.print <span class="s"><span class="dl">'</span><span class="k">Press key to print demo.</span><span class="dl">'</span></span>; gets
  <span class="c"># Just use this file as an example of Ruby code.</span>
  code = <span class="co">File</span>.read(<span class="pc">__FILE__</span>)[<span class="rx"><span class="dl">/</span><span class="k">module CodeRay.*</span><span class="dl">/</span><span class="mod">m</span></span>]
  print <span class="co">CodeRay</span>.scan(code, <span class="sy">:ruby</span>).html
<span class="r">end</span>
</div>
</body>
</html>
